<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Turner - 2025 Big Board</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
  <style>
    :root{
      --bg:#0b0e14; --fg:#e6edf3; --muted:#9aa4af; --accent:#6aa0ff; --danger:#ff5d5d; --warn:#ffcc66; --ok:#6bd97b;
      --card:#121826; --border:#243043; --chip:#1a2233; --gold:#f0c419;
    }
    * { box-sizing: border-box; }
    html,body{
      margin:0;padding:0;background:var(--bg);color:var(--fg);
      font:clamp(14px, 2.5vw, 16px)/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    /* NAV */
    .nav{position:sticky;top:0;z-index:100;backdrop-filter:saturate(150%) blur(6px);
      background:linear-gradient(180deg,rgba(11,14,20,.95),rgba(11,14,20,.9));
      border-bottom:1px solid var(--border);touch-action:manipulation}
    .nav .wrap{max-width:100%;margin:0;display:flex;align-items:center;gap:clamp(6px, 2vw, 10px);
      padding:clamp(8px, 2vh, 12px) clamp(12px, 3vw, 16px);overflow-x:auto;scrollbar-width:none}
    .nav .wrap::-webkit-scrollbar{display:none}
    .brand{font-weight:700;font-size:clamp(14px, 3.5vw, 18px);white-space:nowrap}
    .spacer{flex:1;min-width:8px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--chip);color:var(--fg);
      padding:clamp(6px, 1.5vw, 8px) clamp(8px, 2.5vw, 12px);border-radius:10px;cursor:pointer;
      font-size:clamp(12px, 2.2vw, 14px);white-space:nowrap;flex-shrink:0;touch-action:manipulation;
      transition:all .2s ease;min-height:44px}
    .btn:hover,.btn:focus{filter:brightness(1.1);outline:2px solid var(--accent);outline-offset:2px}
    .btn:active{transform:scale(.98)}
    .btn.primary{background:var(--accent);border-color:transparent;color:#071024}
    .btn.ghost{background:transparent}
    .legend{color:var(--muted);font-size:clamp(10px, 2vw, 12px)}

    /* LAYOUT */
    .container{height:calc(100vh - 60px);display:flex;flex-direction:column;padding:0 clamp(12px, 3vw, 16px);overflow:hidden}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;flex:1;overflow:hidden;display:flex;flex-direction:column;margin:clamp(12px, 2vh, 20px) 0}
    .list{list-style:none;margin:0;padding:0;flex:1;overflow:hidden}
    .row{display:flex;align-items:center;gap:clamp(8px, 2vw, 10px);
      padding:clamp(10px, 2.5vh, 12px) clamp(10px, 2.5vw, 12px);
      border-bottom:1px solid var(--border);cursor:pointer;user-select:none;
      transition:background .2s ease;position:relative;background:transparent}
    .row:last-child{border-bottom:none}
    .row:hover{background:rgba(255,255,255,.02)}
    .row.high-ppg{border-left:3px solid var(--ok);background:linear-gradient(90deg, rgba(107,217,123,.1), var(--card))}
    .row-content{display:flex;align-items:center;gap:clamp(8px, 2vw, 10px);width:100%}
    .drag-handle{color:var(--muted);font-size:18px;cursor:grab;padding: clamp(4px, 1vw, 6px);touch-action:none;border-radius:4px;margin-left:auto}
    .drag-handle:active{cursor:grabbing;background: rgba(255,255,255,.1)}
    .drag-handle:hover{background: rgba(255,255,255,.05)}
    .rank{min-width:clamp(30px, 8vw, 40px);text-align:right;color:var(--muted);font-variant-numeric:tabular-nums}
    .name{flex:1;min-width:0}
    .meta{color:var(--muted);font-variant-numeric:tabular-nums;font-size:clamp(11px, 2.2vw, 13px)}
    .chips{display:flex;gap:clamp(4px, 1vw, 6px);align-items:center;flex-wrap:wrap}
    .chip{padding:2px clamp(6px, 1.5vw, 8px);border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:clamp(10px, 2vw, 12px);color:var(--muted);white-space:nowrap}
    .flag-red{color:#fff;background:#7a1f28;border-color:#b13f4c}
    .pick{background:#0f2a47;border-color:#1c4b7f;color:#91c8ff}
    .depth-rank{background:#1a4b3a;border-color:#2d7a5c;color:#66d49f;font-weight:600;font-size:clamp(9px, 1.8vw, 11px)}
    .depth-rank.rank-2{background:#4b3d1a;border-color:#7a6c2d;color:#d4c166}
    .depth-rank.rank-3{background:#4b1a1a;border-color:#7a2d2d;color:#d46666}
    .depth-rank.rank-backup{background:#2a2a2a;border-color:#444;color:#aaa}
    .rookie-badge{background:linear-gradient(135deg, var(--gold), #e6a800);border:1px solid #d49400;color:#071024;font-weight:700;font-size:clamp(9px, 1.8vw, 11px)}
    .injury-indicator{color:#ff6b6b;padding:2px;font-size:clamp(11px, 2.2vw, 14px);opacity:.9}
    .handcuff-icon{color:#ffa500;font-size:clamp(12px, 2.5vw, 14px);margin-left:4px;opacity:.8}
    .row.assigned{opacity:.88;background:linear-gradient(90deg, rgba(106,160,255,.14), rgba(106,160,255,0));border-left:3px solid var(--accent)}

    /* Scrollable list: trackpad/touch friendly */
    #liveList{overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
    #liveList::-webkit-scrollbar{width:6px}
    #liveList::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
    #liveList::-webkit-scrollbar-track{background:transparent}

    .legend-row{position:sticky;top:0;background:var(--card);z-index:10;border-bottom:2px solid var(--border);padding:clamp(8px, 2vh, 12px) clamp(10px, 2.5vw, 12px)}
    .legend-row .legend{font-size:clamp(10px, 2vw, 12px);line-height:1.3}

    /* Pointer DnD visuals */
    .drag-ghost{position:fixed;left:0;right:0;pointer-events:none;z-index:1000;transform:translateY(-50%);opacity:.95;box-shadow:0 12px 24px rgba(0,0,0,.45)}
    .drag-ghost .row{background:rgba(20,26,40,.98);border-color:var(--accent)}
    .placeholder{height:var(--ph-h, 48px);border:2px dashed var(--accent);border-radius:10px;margin:2px 8px;background:rgba(106,160,255,.08)}
    body.dragging { user-select:none; cursor:grabbing; }

    /* PRINT */
    @media print{
      body{background:#fff;color:#000;margin:0;padding:8px}
      .nav, #liveSection{display:none !important}
      #printSection{display:block !important}
      .print-header{ text-align:center;font-size:16px;font-weight:bold;margin-bottom:12px;color:#000;border-bottom:2px solid #333;padding-bottom:4px }
      .print-grid{ display:grid;grid-template-columns:repeat(4, 1fr);gap:6px;width:100%;page-break-inside:avoid }
      .print-col{ break-inside:avoid;border:1px solid #ccc;border-radius:4px;padding:4px;background:#fff;font-size:10px;line-height:1.2 }
      .print-col-header{ background:#f5f5f5;border-bottom:2px solid #ccc;padding:4px;text-align:center;font-weight:bold;font-size:11px;color:#333;margin-bottom:2px }
      .print-col .list{ margin:0;padding:0;list-style:none }
      .print-col .row{ display:flex;align-items:center;gap:4px;padding:2px 4px;border-bottom:1px solid #eee;font-size:10px;line-height:1.2 }
      .print-col .row:last-child{border-bottom:none}
      .print-col .rank{min-width:20px;text-align:right;color:#666;font-weight:bold}
      .print-col .name{flex:1;font-weight:500}
      .print-col .meta{color:#666;font-size:9px}
      .print-col .chips{display:flex;gap:2px;align-items:center}
      .print-col .chip{padding:1px 3px;border-radius:2px;font-size:8px;white-space:nowrap}
      .print-col .drag-handle{display:none}
    }
    #printSection{display:none}

    /* Modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:clamp(16px, 4vw, 20px);z-index:9999;backdrop-filter:blur(4px)}
    .modal{width:min(90vw, 600px);max-height:90vh;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.7);overflow:hidden;display:flex;flex-direction:column}
    .modal-header{display:flex;align-items:center;gap:10px;justify-content:flex-start;padding:clamp(12px, 3vw, 16px);border-bottom:1px solid var(--border);flex-shrink:0}
    .modal-title{font-weight:700;font-size:clamp(16px, 3.5vw, 18px);display:flex;align-items:center;gap:10px}
    .modal-close{margin-left:auto;border:none;background:transparent;color:var(--muted);font-size:24px;cursor:pointer;width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:8px}
    .modal-close:hover,.modal-close:focus{background:rgba(255,255,255,.1);outline:2px solid var(--accent);outline-offset:2px}
    .modal-body{padding:clamp(12px, 3vw, 16px);display:flex;flex-direction:column;gap:clamp(12px, 3vw, 16px);overflow-y:auto;flex:1}
    .modal-footer{padding:clamp(12px, 3vw, 16px);border-top:1px solid var(--border);display:flex;gap:clamp(8px, 2vw, 12px);justify-content:flex-end;flex-shrink:0}
    .header-actions{display:flex;gap:8px;align-items:center}
    .icon-toggle{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);background:var(--chip);color:var(--fg);border-radius:8px;cursor:pointer;font-size:13px;user-select:none;transition:filter .2s ease, transform .05s ease}
    .icon-toggle .bi{font-size:16px}
    .icon-toggle:active{transform:scale(.98)}
    .icon-toggle.is-on.star{background:rgba(240,196,25,.15);border-color:#caa72a;color:#f0c419}
    .icon-toggle.is-on.warn{background:rgba(255,93,93,.15);border-color:#b34a4a;color:#ff5d5d}

    .table{width:100%;border-collapse:collapse;border:1px solid var(--border);font-size:clamp(11px, 2.2vw, 13px);max-height:40vh;overflow-y:auto;display:block}
    .table th,.table td{border-bottom:1px solid var(--border);padding:clamp(6px, 1.5vw, 8px);text-align:left}
    .help{color:var(--muted);font-size:clamp(11px, 2.2vw, 13px)}
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav" id="nav">
    <div class="wrap">
      <div class="brand">Turner - 2025 Big Board</div>
      <div class="spacer"></div>
      <input type="text" id="searchInput" class="btn" style="flex:2;min-width:120px;max-width:300px;" placeholder="Search players..." autocomplete="off" />
      <button class="btn" id="btnUpload">Import Data</button>
      <button class="btn" id="btnReset">Reset</button>
      <button class="btn" id="btnRosters">Rosters</button>
      <button class="btn primary" id="btnPrint">Print</button>
    </div>
  </div>

  <!-- LIVE LIST -->
  <div class="container" id="liveSection">
    <div class="card">
      <div class="legend-row">
        <div class="legend">Double-click a player row to open details. ⭐ Target and ⚠ Warning can be toggled in the modal. Double-click the modal body to assign a league team. Drag via ⋮⋮ to reorder.</div>
      </div>
      <ul class="list" id="liveList"></ul>
    </div>
  </div>

  <!-- PRINT LIST -->
  <div class="container" id="printSection">
    <div class="print-header" id="printHeader">Turner - 2025 Fantasy Football Big Board</div>
    <div class="print-grid" id="printGrid"></div>
  </div>
  <footer class="print">Generated on <span id="printDate"></span></footer>

  <!-- Modal: Upload Data -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Load External Data</div>
        <button class="modal-close" id="modalClose" aria-label="Close">×</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div id="step1">
          <div class="form-row">
            <div class="form-group" style="flex:1">
              <label for="importUrl">Enter URL</label>
              <input type="text" id="importUrl" placeholder="Enter Url" aria-describedby="importUrlHelp" style="width:100%;min-height:44px;background:#0f1524;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px" />
              <small id="importUrlHelp" class="help">If a file is uploaded, the URL data will be ignored.</small>
            </div>
            <button class="btn" id="btnLoadUrl">Load Data</button>
          </div>
          <div class="or" style="margin:10px 0;color:var(--muted)">or</div>
          <div class="form-group">
            <label for="importFile">Upload File</label>
            <input type="file" id="importFile" accept=".json" />
          </div>
          <details style="margin-top:10px">
            <summary>JSON Schema (expected file format)</summary>
            <pre id="jsonSchema" style="white-space:pre-wrap;background:#0a0d12;border:1px solid var(--border);border-radius:8px;padding:8px;color:var(--muted)"></pre>
          </details>
        </div>
        <div id="step2" style="display:none">
          <div class="legend">Preview first 20 rows</div>
          <table class="table" id="previewTable">
            <thead>
              <tr>
                <th>rk</th><th>name</th><th>team</th><th>pos</th><th>ppg</th><th>risk</th><th>pickMarker</th><th>target</th><th>avoid</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="validateMsg" class="help"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="btnBack" style="display:none">Back</button>
        <button class="btn" id="btnContinue" style="display:none">Continue</button>
      </div>
    </div>
  </div>

  <!-- Modal: Player Details / Notes -->
  <div class="modal-backdrop" id="notesModalBackdrop" aria-hidden="true" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="notesModalTitle">
      <div class="modal-header">
        <div class="modal-title" id="notesModalTitle"><span id="playerDetailsName">Player Name</span></div>
        <div class="header-actions">
          <button class="icon-toggle star" id="toggleTargetBtn" title="Toggle Target">
            <i class="bi bi-star" id="toggleTargetIcon"></i><span>Target</span>
          </button>
          <button class="icon-toggle warn" id="toggleWarnBtn" title="Toggle Warning">
            <i class="bi bi-exclamation-triangle" id="toggleWarnIcon"></i><span>Warning</span>
          </button>
        </div>
        <button class="modal-close" id="notesModalClose" aria-label="Close">×</button>
      </div>

      <div class="modal-body" id="notesModalBody">
        <div class="player-details">
          <div class="player-info-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px">
            <div class="info-row"><strong>Rank:</strong> <span id="playerRank"></span></div>
            <div class="info-row"><strong>Team:</strong> <span id="playerTeam"></span></div>
            <div class="info-row"><strong>Position:</strong> <span id="playerPos"></span></div>
            <div class="info-row"><strong>PPG:</strong> <span id="playerPPG"></span></div>
          </div>

          <div id="depthChartSection" class="depth-chart-section" style="display:none;margin-top:8px;padding:8px;background:rgba(106,160,255,.1);border:1px solid var(--accent);border-radius:8px">
            <h4 style="margin:0 0 6px 0;color:var(--accent);font-size:16px">Depth Chart Information</h4>
            <div class="depth-info-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px">
              <div class="depth-info-item"><strong>Depth Rank:</strong> <span id="depthRank" class="chip"></span></div>
              <div class="depth-info-item"><strong>NFL Team:</strong> <span id="depthTeam"></span></div>
              <div class="depth-info-item"><strong>Draft Info:</strong> <span id="depthDraft"></span></div>
              <div class="depth-info-item"><strong>Status:</strong> <span id="depthStatus" class="chip"></span></div>
            </div>
          </div>

          <div id="injuriesSection" class="injuries-section" style="display:none;margin-top:8px;padding:8px;background:rgba(239,68,68,.1);border:1px solid var(--danger);border-radius:8px">
            <h4 style="margin:0 0 6px 0;color:var(--danger);font-size:16px">Injury Report</h4>
            <div id="injuriesList"></div>
          </div>

          <details style="margin-top:8px"><summary>Full JSON Details</summary><pre id="playerJsonDetails" style="white-space:pre-wrap;background:#0a0d12;border:1px solid var(--border);border-radius:8px;padding:8px;color:var(--muted)"></pre></details>

          <div class="player-outlook" id="playerOutlook" style="display:none;margin-top:8px;padding:8px;background:rgba(106,160,255,.1);border-left:3px solid var(--accent);border-radius:0 8px 8px 0">
            <h4 style="margin:0 0 6px 0;color:var(--accent);font-size:16px">Outlook</h4><p id="playerOutlookText" style="margin:0"></p>
          </div>
        </div>

        <div class="notes-section" style="border-top:1px solid var(--border);padding-top:12px;margin-top:12px">
          <h4 style="display:flex;align-items:center;justify-content:space-between;margin:0 0 6px 0">Your Notes
            <span class="legend">(<span id="notesCharCount">0</span>/300)</span>
          </h4>
          <textarea id="playerNotesInput" placeholder="Add your personal notes about this player (300 character limit)..." maxlength="300" rows="4" style="width:100%;resize:vertical;min-height:80px;background:#0f1524;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn ghost" id="notesModalCancel">Cancel</button>
        <button class="btn primary" id="notesModalSave">Save Notes</button>
      </div>
    </div>
  </div>

  <!-- Modal: Rosters -->
  <div class="modal-backdrop" id="rostersModalBackdrop" aria-hidden="true" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rostersModalTitle">
      <div class="modal-header">
        <div class="modal-title" id="rostersModalTitle">League Rosters</div>
        <button class="modal-close" id="rostersModalClose" aria-label="Close">×</button>
      </div>
      <div class="modal-body" id="rostersModalBody" style="max-height:70vh;overflow-y:auto;"></div>
      <div class="modal-footer">
        <button class="btn ghost" id="rostersModalCancel">Close</button>
      </div>
    </div>
  </div>
  <!-- Modal: Assign Team -->
  <div class="modal-backdrop" id="teamModalBackdrop" aria-hidden="true" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="teamModalTitle">
      <div class="modal-header">
        <div class="modal-title" id="teamModalTitle">Assign Team</div>
        <button class="modal-close" id="teamModalClose" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <label for="teamSelect" class="legend" style="display:block;margin-bottom:8px;">Select destination roster</label>
        <select id="teamSelect" style="width:100%;min-height:44px;background:#0f1524;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:15px;"></select>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="teamModalCancel">Cancel</button>
      </div>
    </div>
  </div>

<script>

'use strict';
const $ = (sel, root=document) => root.querySelector(sel);

/* ---------- Storage ---------- */
const STORAGE_KEY = 'turnerBigBoardSeeds';
/**
 * Loads seeds from localStorage. Returns an array of player objects, or an empty array if not found or invalid.
 */
function loadSeeds(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    const seeds = JSON.parse(raw);
    return Array.isArray(seeds) ? seeds.map(p => ({ ...p, avoid: p.avoid || false })) : [];
  } catch {
    return [];
  }
}
/**
 * Saves seeds to localStorage. Wraps in try/catch and validates JSON before saving.
 */
function saveSeeds(seeds){
  try {
    if (!Array.isArray(seeds)) throw new Error('Seeds must be an array');
    localStorage.setItem(STORAGE_KEY, JSON.stringify(seeds || []));
  } catch {}
}
/**
 * Resets seeds in localStorage and clears the live list.
 */
function resetSeeds(){
  localStorage.removeItem(STORAGE_KEY);
  renderLiveList([]);
  autoLoadInitialData();
}

/* ---------- League Teams (from screenshot) ---------- */
const LEAGUE_TEAMS = [
  { id:'VAIN', team:'Otown Vainglorious', manager:'Michael Haverty' },
  { id:'JFT',  team:"Justin's Finest Team", manager:'Justin Jackson' },
  { id:'GoLD', team:'Go Long Dog', manager:'Jerry Smith' },
  { id:'JST',  team:"Joshua's Scary Team", manager:'Joshua Bennett' },
  { id:'GS',   team:'Gus Swayze', manager:'Jeremy Scott' },
  { id:'SST',  team:"Sterling's Smart Team", manager:'Sterling Ballard' },
  { id:'PK',   team:'(-_-)', manager:'Paul Kaneshige' },
  { id:'ETG',  team:'East Tulsa Golfers', manager:'Robert Stage' },
  { id:'AG',   team:'A Grip', manager:'Aaron Grippando' },
  { id:'MATT', team:'Like Keanu', manager:'Matt T' }
];

/* ---------- Pointer Drag & Drop ---------- */
let dnd = {active:false,list:null,ghost:null,placeholder:null,srcEl:null,srcIndex:-1,pointerOffsetY:0,rafId:0,autoScrollSpeed:0};
function initPointerDnd(){ dnd.list = $('#liveList'); if(!dnd.list) return; dnd.list.addEventListener('pointerdown', onPointerDown); }
function onPointerDown(e){
  const handle = e.target.closest('.drag-handle'); const row = e.target.closest('.row'); if(!handle || !row || !dnd.list.contains(row)) return;
  e.preventDefault(); row.setPointerCapture?.(e.pointerId);
  const rect = row.getBoundingClientRect();
  dnd.active = true; dnd.srcEl = row; dnd.srcIndex = indexOfChild(dnd.list,row); dnd.pointerOffsetY = e.clientY - rect.top;
  dnd.ghost = document.createElement('div'); dnd.ghost.className='drag-ghost'; dnd.ghost.style.width=rect.width+'px'; dnd.ghost.style.top=(e.clientY)+'px'; dnd.ghost.innerHTML=row.outerHTML; document.body.appendChild(dnd.ghost);
  dnd.placeholder = document.createElement('div'); dnd.placeholder.className='placeholder'; dnd.placeholder.style.setProperty('--ph-h', rect.height+'px'); dnd.srcEl.after(dnd.placeholder); dnd.srcEl.style.display='none';
  document.body.classList.add('dragging');
  window.addEventListener('pointermove', onPointerMove, {passive:false});
  window.addEventListener('pointerup', onPointerUp, {passive:true});
  startAutoScrollLoop();
}
function onPointerMove(e){
  if(!dnd.active) return; e.preventDefault();
  dnd.ghost.style.top = (e.clientY) + 'px';
  const targetIndex = computeInsertIndex(e.clientY);
  if(targetIndex !== -1){
    const currentIndex = indexOfChild(dnd.list,dnd.placeholder);
    if(targetIndex !== currentIndex){
      const ref = dnd.list.children[targetIndex];
      ref ? dnd.list.insertBefore(dnd.placeholder, ref) : dnd.list.appendChild(dnd.placeholder);
    }
  }
  maybeSetAutoScroll(e.clientY);
}
function onPointerUp(){
  if(!dnd.active) return;
  stopAutoScrollLoop();
  window.removeEventListener('pointermove', onPointerMove);
  window.removeEventListener('pointerup', onPointerUp);
  const seeds = loadSeeds();
  if(seeds.length){
    const finalIndex = indexOfChild(dnd.list, dnd.placeholder);
    if(dnd.srcIndex>-1 && finalIndex>-1){
      const sorted = seeds.slice().sort((a,b)=>a.rk-b.rk);
      const [moved] = sorted.splice(dnd.srcIndex,1);
      sorted.splice(finalIndex,0,moved);
      sorted.forEach((p,i)=> p.rk=i+1);
      saveSeeds(sorted); renderLiveList(sorted);
    }
  }
  if(dnd.ghost?.parentNode) dnd.ghost.parentNode.removeChild(dnd.ghost);
  if(dnd.placeholder?.parentNode){ dnd.srcEl.style.display=''; dnd.placeholder.parentNode.removeChild(dnd.placeholder); }
  document.body.classList.remove('dragging');
  dnd = {active:false,list:$('#liveList'),ghost:null,placeholder:null,srcEl:null,srcIndex:-1,pointerOffsetY:0,rafId:0,autoScrollSpeed:0};
}
function indexOfChild(parent, el){ return Array.prototype.indexOf.call(parent.children, el); }
function computeInsertIndex(y){ const kids = Array.from(dnd.list.children).filter(n=>n!==dnd.srcEl && n!==dnd.placeholder); for(let i=0;i<kids.length;i++){ const r=kids[i].getBoundingClientRect(); if(y < r.top + r.height/2) return i; } return kids.length; }
function maybeSetAutoScroll(y){ const r = dnd.list.getBoundingClientRect(), th=48; let s=0; if(y-r.top < th) s = -speed(th-(y-r.top)); else if(r.bottom-y < th) s = speed(th-(r.bottom-y)); dnd.autoScrollSpeed=s; }
function speed(d){ const k=.35; return Math.min(24, Math.max(2, k*d*2)); }
function step(){ if(dnd.active && dnd.autoScrollSpeed!==0) dnd.list.scrollTop += dnd.autoScrollSpeed; dnd.rafId=requestAnimationFrame(step); }
function startAutoScrollLoop(){ stopAutoScrollLoop(); dnd.rafId=requestAnimationFrame(step); }
function stopAutoScrollLoop(){ if(dnd.rafId) cancelAnimationFrame(dnd.rafId); dnd.rafId=0; }

/* ---------- Schema (display only) ---------- */
const schema = {"$schema":"https://json-schema.org/draft/2020-12/schema","title":"BigBoardSeeds","type":"array","items":{"type":"object","required":["rk","name","team","pos","ppg","risk","pickMarker","target"],"properties":{"rk":{"type":"integer","minimum":1},"name":{"type":"string","minLength":1},"team":{"type":"string","minLength":2},"pos":{"type":"string","enum":["QB","RB","WR","TE","K","DST","D/ST","DEF"]},"ppg":{"type":["number","null"]},"risk":{"type":"boolean"},"pickMarker":{"type":"string"},"target":{"type":"boolean"},"avoid":{"type":"boolean"},"notes":{"type":"string"}},"additionalProperties":true}};
$('#jsonSchema').textContent = JSON.stringify(schema, null, 2);

/* ---------- Decorations helpers ---------- */
const injuryProneStarters = ['Aaron Rodgers','Russell Wilson','Kirk Cousins','Ryan Tannehill','Christian McCaffrey','Saquon Barkley','Jonathan Taylor','Derrick Henry','Nick Chubb','Leonard Fournette','Dalvin Cook','Alvin Kamara','Keenan Allen','Mike Evans','Chris Godwin','Michael Thomas','Tyler Lockett','JuJu Smith-Schuster','Jerry Jeudy','Travis Kelce','Mark Andrews','George Kittle','Kyle Pitts'];
function isHandcuffPlayer(p, all){ if((p.depthPosition&&p.depthPosition===1)||(p.depthChartInfo&&p.depthChartInfo.rank===1)) return false; const starter = all.find(x=>x.team===p.team && x.pos===p.pos && x.depthChartInfo && x.depthChartInfo.rank===1); if(!starter) return false; return injuryProneStarters.some(n => starter.name.toLowerCase().includes(n.toLowerCase()) || n.toLowerCase().includes(starter.name.toLowerCase())); }
function isRookie(p){ if(!p.depthChartInfo||!p.depthChartInfo.draft) return false; const y=new Date().getFullYear(); const m=p.depthChartInfo.draft.match(/Year:\s*(\d{4})/); return m && parseInt(m[1])===y; }
function getDepthRankBadge(p){ if(!p.depthChartInfo) return ''; const r=p.depthChartInfo.rank; if(!r||r>3) return '<span class="chip depth-rank rank-backup">BACKUP</span>'; return `<span class="chip depth-rank rank-${r}">D${r}</span>`; }
function getInjuryIndicator(p){ if(!p.depthChartInfo||!p.depthChartInfo.injuries||!p.depthChartInfo.injuries.length) return ''; return '<i class="bi bi-hospital injury-indicator" title="Has injury history"></i>'; }
function getRookieBadge(p){ return isRookie(p) ? '<span class="chip rookie-badge">ROOKIE</span>' : ''; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

/* ---------- Row rendering ---------- */
function rowHtml(p, index, all=[]){
  const flags=[]; if(p.risk || (p.team==='DAL'||p.team==='MIA')) flags.push('<span class="chip flag-red">⚠️</span>');
  if(p.pickMarker) flags.push(`<span class="chip pick">${p.pickMarker}</span>`);
  const dr = getDepthRankBadge(p); if(dr) flags.push(dr);
  const rb = getRookieBadge(p); if(rb) flags.push(rb);
  const ppg = (p.ppg==null) ? '—' : Number(p.ppg).toFixed(2);
  const high = (p.ppg!=null && p.ppg>=14) ? ' high-ppg' : '';
  const hand = isHandcuffPlayer(p, all) ? '<i class="bi bi-link-45deg handcuff-icon" title="Handcuff to injury-prone starter"></i>' : '';
  const injury = getInjuryIndicator(p);
  let always=''; if(p.target) always += `<span class="chip" title="Target">⭐</span>`; if(p.avoid) always += `<span class="chip" title="Avoid">🚫</span>`;
  const assignedClass = p.assignedTeam ? ' assigned' : '';
  return `<li class="row${high}${assignedClass}" data-index="${index}" data-player-id="${p.rk}">
    <div class="row-content">
      <div class="rank">${p.rk}.</div>
      <div class="name"><span class="player-name">${escapeHtml(p.name)}</span>${injury}${hand} <span class="meta">(${p.pos} - ${p.team})</span> ${always}</div>
      <div class="meta">${ppg} PPG</div>
      <div class="chips">${flags.join('')}</div>
      <div class="drag-handle" title="Hold and drag to reorder">⋮⋮</div>
    </div>
  </li>`;
}
/**
 * Renders the live player list, optionally filtered by fuzzy search.
 * @param {Array} seeds - The full player list.
 * @param {string} [searchTerm] - Optional search term for fuzzy filtering.
 */
function renderLiveList(seeds, searchTerm = '') {
  const list = $('#liveList');
  if (!list) return;
  let sorted = (seeds || []).slice().sort((a, b) => a.rk - b.rk);
  let filtered = sorted;
  if (searchTerm && searchTerm.trim()) {
    filtered = fuzzyFilterPlayers(sorted, searchTerm.trim());
  }
  list.innerHTML = filtered.map((p, i) => rowHtml(p, i, filtered)).join('');
  // double-click a row to open modal
  list.onmousedown = null; // ensure clean state for DnD handler binding
  list.addEventListener('dblclick', (e) => {
    const row = e.target.closest('.row');
    if (!row) return;
    const index = parseInt(row.dataset.index, 10);
    if (Number.isInteger(index)) {
      // Use filtered list and pass playerId
      const playerId = parseInt(row.dataset.playerId, 10);
      openPlayerNotesById(playerId, filtered);
    }
  });

  // --- Swipe right gesture for Assign Team modal ---
  let touchStartX = 0, touchStartY = 0, touchMoved = false;
  list.addEventListener('touchstart', (e) => {
    const row = e.target.closest('.row');
    if (!row) return;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    touchMoved = false;
    row._swipeActive = true;
  }, {passive:true});
  list.addEventListener('touchmove', (e) => {
    const row = e.target.closest('.row');
    if (!row || !row._swipeActive) return;
    const dx = e.touches[0].clientX - touchStartX;
    const dy = Math.abs(e.touches[0].clientY - touchStartY);
    // Only consider horizontal swipe, ignore vertical scroll
    if (dx > 40 && dy < 30 && !touchMoved) {
      touchMoved = true;
      row._swipeActive = false;
      const playerId = parseInt(row.dataset.playerId, 10);
      openTeamModalById(playerId);
    }
  }, {passive:true});
  list.addEventListener('touchend', (e) => {
    const row = e.target.closest('.row');
    if (row) row._swipeActive = false;
    touchMoved = false;
  }, {passive:true});
  // (re)bind pointer DnD
  dnd.list?.removeEventListener?.('pointerdown', onPointerDown);
  initPointerDnd();
}

/**
 * Fuzzy filters players by name, team, or position.
 * @param {Array} players
 * @param {string} term
 * @returns {Array}
 */
function fuzzyFilterPlayers(players, term) {
  const t = term.toLowerCase();
  return players.filter(p =>
    (p.name && p.name.toLowerCase().includes(t)) ||
    (p.team && p.team.toLowerCase().includes(t)) ||
    (p.pos && p.pos.toLowerCase().includes(t))
  );
}

/**
 * Opens player details modal by playerId, using the filtered list.
 * @param {number} playerId
 * @param {Array} filteredList
 */
function openPlayerNotesById(playerId, filteredList) {
  // Find the player in the filtered list
  const index = filteredList.findIndex(p => p.rk === playerId);
  if (index === -1) return;
  // Use filteredList for modal context
  openPlayerNotesFiltered(index, filteredList);
}

/**
 * Opens player details modal for filtered list context.
 * @param {number} index
 * @param {Array} filteredList
 */
function openPlayerNotesFiltered(index, filteredList) {
  if (!filteredList[index]) return;
  currentPlayerIndex = index;
  const p = filteredList[index];
  $('#playerDetailsName').textContent = p.name;
  $('#playerRank').textContent = p.rk;
  $('#playerTeam').textContent = p.team;
  $('#playerPos').textContent = p.pos;
  $('#playerPPG').textContent = p.ppg == null ? '—' : Number(p.ppg).toFixed(2);
  populateDepthChartInfo(p);
  populateInjuriesInfo(p);
  $('#playerJsonDetails').textContent = JSON.stringify(p, null, 2);
  if (p.outlook && p.outlook.trim()) {
    $('#playerOutlook').style.display = 'block';
    $('#playerOutlookText').textContent = p.outlook;
  } else {
    $('#playerOutlook').style.display = 'none';
  }
  $('#playerNotesInput').value = p.notes || '';
  updateCharCount();
  const targetBtn = $('#toggleTargetBtn'), warnBtn = $('#toggleWarnBtn');
  const targetIcon = $('#toggleTargetIcon'), warnIcon = $('#toggleWarnIcon');
  const setTargetUI = on => { targetBtn.classList.toggle('is-on', !!on); targetIcon.className = on ? 'bi bi-star-fill' : 'bi bi-star'; };
  const setWarnUI = on => { warnBtn.classList.toggle('is-on', !!on); warnIcon.className = on ? 'bi bi-exclamation-triangle-fill' : 'bi bi-exclamation-triangle'; };
  setTargetUI(!!p.target); setWarnUI(!!p.risk);
  targetBtn.onclick = () => { toggleTargetAtFiltered(index, filteredList); setTargetUI(filteredList[index].target); };
  warnBtn.onclick = () => { toggleRiskAtFiltered(index, filteredList); setWarnUI(filteredList[index].risk); };
  const modal = $('#notesModalBackdrop'); modal.style.display = 'flex'; modal.setAttribute('aria-hidden', 'false'); document.body.style.overflow = 'hidden';
  $('#notesModalBody').scrollTop = 0;
  $('#notesModalBody').ondblclick = () => openTeamModalById(p.rk);
}

function toggleTargetAtFiltered(index, filteredList) {
  filteredList[index].target = !filteredList[index].target;
  // Update main seeds
  const seeds = loadSeeds();
  const mainIndex = seeds.findIndex(p => p.rk === filteredList[index].rk);
  if (mainIndex !== -1) {
    seeds[mainIndex].target = filteredList[index].target;
    saveSeeds(seeds);
    renderLiveList(seeds, $('#searchInput').value);
  }
}
function toggleRiskAtFiltered(index, filteredList) {
  filteredList[index].risk = !filteredList[index].risk;
  const seeds = loadSeeds();
  const mainIndex = seeds.findIndex(p => p.rk === filteredList[index].rk);
  if (mainIndex !== -1) {
    seeds[mainIndex].risk = filteredList[index].risk;
    saveSeeds(seeds);
    renderLiveList(seeds, $('#searchInput').value);
  }
}
function openTeamModalById(playerId) {
  const seeds = loadSeeds();
  const index = seeds.findIndex(p => p.rk === playerId);
  if (index !== -1) openTeamModal(index);
}

/* ---------- Toggle helpers ---------- */
function toggleTargetAt(index){ const s=loadSeeds(); if(!s[index]) return; s[index].target=!s[index].target; saveSeeds(s); renderLiveList(s); }
function toggleRiskAt(index){ const s=loadSeeds(); if(!s[index]) return; s[index].risk=!s[index].risk; saveSeeds(s); renderLiveList(s); }

/* ---------- Player Modal ---------- */
let currentPlayerIndex = -1;
// ...existing code...
function populateDepthChartInfo(player){
  const section = $('#depthChartSection'); if(player.depthChartInfo){ const d=player.depthChartInfo;
    section.style.display='block';
    $('#depthRank').textContent = (d.rank ? `Depth #${d.rank}` : '—');
    $('#depthTeam').textContent = d.team || 'Unknown';
    $('#depthDraft').textContent = d.draft || 'Unknown';
    $('#depthStatus').textContent = d.status || 'Unknown';
  } else { section.style.display='none'; }
}
function populateInjuriesInfo(player){
  const sec = $('#injuriesSection'), list = $('#injuriesList');
  if(player.depthChartInfo && player.depthChartInfo.injuries && player.depthChartInfo.injuries.length){
    sec.style.display='block'; list.innerHTML='';
    player.depthChartInfo.injuries.forEach(inj=>{
      const el=document.createElement('div'); el.style.margin='6px 0'; el.style.padding='6px'; el.style.background='rgba(0,0,0,.3)'; el.style.borderRadius='6px';
      const date = inj.date ? new Date(inj.date).toLocaleDateString() : '';
      el.innerHTML = `<div style="font-weight:bold;color:var(--danger)">${escapeHtml(inj.status||'Unknown')}</div>
                      <div style="color:var(--muted)">${escapeHtml(inj.shortComment||'No details')}</div>
                      ${date?`<div class="legend">Updated: ${date}</div>`:''}`;
      list.appendChild(el);
    });
  }else{ sec.style.display='none'; }
}
function closePlayerNotesModal(){ const m=$('#notesModalBackdrop'); m.style.display='none'; m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; currentPlayerIndex=-1; }
function savePlayerNotes(){ if(currentPlayerIndex===-1) return; const s=loadSeeds(); if(!s[currentPlayerIndex]) return; s[currentPlayerIndex].notes = $('#playerNotesInput').value.trim(); saveSeeds(s); renderLiveList(s); closePlayerNotesModal(); }
function updateCharCount(){ const n=$('#playerNotesInput').value.length; $('#notesCharCount').textContent=n; }

/* Close handlers */
$('#notesModalClose').addEventListener('click', closePlayerNotesModal);
$('#notesModalCancel').addEventListener('click', closePlayerNotesModal);
$('#notesModalSave').addEventListener('click', savePlayerNotes);
$('#notesModalBackdrop').addEventListener('click', (e)=>{ if(e.target === $('#notesModalBackdrop')) closePlayerNotesModal(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && $('#notesModalBackdrop').style.display==='flex') closePlayerNotesModal(); });

/* ---------- Assign Team Modal ---------- */
function openTeamModal(index){
  const teamModal = $('#teamModalBackdrop');
  const sel = $('#teamSelect');
  sel.innerHTML = `<option value="" selected>Assign a team...</option>` +
    LEAGUE_TEAMS.map(t => `<option value="${t.id}">${t.id} — ${escapeHtml(t.team)} (${escapeHtml(t.manager)})</option>`).join('');
  const cur = loadSeeds()[index]?.assignedTeam || '';
  if(cur) sel.value = cur;

  teamModal.style.display='flex'; teamModal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
  sel.focus();

  sel.onchange = () => {
    const val = sel.value;
    const seeds = loadSeeds();
    const player = seeds[index];
    player.assignedTeam = val || null;
    saveSeeds(seeds);
    closeTeamModal();
    renderLiveList(seeds);
  };

  $('#teamModalClose').onclick = closeTeamModal;
  $('#teamModalCancel').onclick = closeTeamModal;
  $('#teamModalBackdrop').onclick = (e)=>{ if(e.target === $('#teamModalBackdrop')) closeTeamModal(); };
}
function closeTeamModal(){ const m=$('#teamModalBackdrop'); m.style.display='none'; m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

/* ---------- Import/Print/Reset ---------- */
function validateAgainstSchema(arr){ const errors=[]; if(!Array.isArray(arr)) return ["Root must be an array of player objects."]; if(arr.length===0) return []; const posSet=new Set(["QB","RB","WR","TE","K","DST","D/ST","DEF"]); arr.forEach((o,idx)=>{ const req=["rk","name","team","pos","ppg","risk","pickMarker","target"]; req.forEach(k=>{ if(!(k in o)) errors.push(`item[${idx}]: missing '${k}'`); }); if(typeof o.rk!=='number'||!Number.isInteger(o.rk)||o.rk<1) errors.push(`item[${idx}]: rk invalid`); if(typeof o.name!=='string'||!o.name.trim()) errors.push(`item[${idx}]: name invalid`); if(typeof o.team!=='string'||o.team.length<2) errors.push(`item[${idx}]: team invalid`); if(typeof o.pos!=='string'||!posSet.has(o.pos)) errors.push(`item[${idx}]: pos invalid`); if(!(o.ppg===null||typeof o.ppg==='number')) errors.push(`item[${idx}]: ppg invalid`); if(typeof o.risk!=='boolean') errors.push(`item[${idx}]: risk invalid`); if(typeof o.pickMarker!=='string') errors.push(`item[${idx}]: pickMarker invalid`); if(typeof o.target!=='boolean') errors.push(`item[${idx}]: target invalid`); if('avoid' in o && typeof o.avoid!=='boolean') errors.push(`item[${idx}]: avoid invalid`); }); return errors; }

const backdrop = $('#modalBackdrop');
function openModal(){ backdrop.style.display='flex'; showStep(1); clearPreview(); document.body.style.overflow='hidden'; }
function closeModal(){ backdrop.style.display='none'; document.body.style.overflow=''; }
function showStep(n){ $('#step1').style.display=(n===1?'block':'none'); $('#step2').style.display=(n===2?'block':'none'); $('#btnBack').style.display=(n===2?'inline-block':'none'); $('#btnContinue').style.display=(n===2?'inline-block':'none'); }
function clearPreview(){ $('#previewTable tbody').innerHTML=''; $('#validateMsg').textContent=''; }

$('#btnUpload').addEventListener('click', openModal);
$('#modalClose').addEventListener('click', closeModal);
$('#btnBack').addEventListener('click', ()=>showStep(1));

$('#btnLoadUrl').addEventListener('click', async () => {
  const url = $('#importUrl').value.trim();
  if (!url) {
    alert('Please enter a URL.');
    return;
  }
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    handleImportedJson(json);
  } catch (err) {
    alert('Failed to load URL: ' + err.message);
  }
});

$('#importFile').addEventListener('change', async (ev) => {
  const file = ev.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const json = JSON.parse(text);
    handleImportedJson(json);
  } catch (err) {
    alert('File read/parse error: ' + err.message);
  }
});

/**
 * Handles imported JSON from URL or file, validates, previews, and sets up for saving to localStorage.
 */
function handleImportedJson(json) {
  const errors = validateAgainstSchema(json);
  const tbody = $('#previewTable tbody');
  clearPreview();
  if (errors.length) {
    $('#validateMsg').innerHTML = '<span style="color:var(--danger)">Schema validation failed:</span><br>' + errors.map(e => `• ${escapeHtml(e)}`).join('<br>');
    return;
  }
  json.slice(0, 20).forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.rk}</td><td>${escapeHtml(p.name)}</td><td>${p.team}</td><td>${p.pos}</td><td>${p.ppg ?? '—'}</td><td>${p.risk}</td><td>${escapeHtml(p.pickMarker || '')}</td><td>${p.target}</td><td>${p.avoid || false}</td>`;
    tbody.appendChild(tr);
  });
  showStep(2);
  $('#btnContinue').onclick = () => {
    const processed = json.map(p => ({ ...p, avoid: p.avoid || false, notes: p.notes || '' }));
    localStorage.removeItem(STORAGE_KEY);
    saveSeeds(processed);
    renderLiveList(processed);
    closeModal();
  };
}

$('#btnReset').addEventListener('click', ()=>{ if(confirm('Reset board and clear session storage?')){ resetSeeds(); sessionStorage.removeItem(STORAGE_KEY); alert('Board reset.'); }});
$('#btnPrint').addEventListener('click', ()=>{ const seeds=loadSeeds(); buildPrint(seeds); window.print(); });
window.addEventListener('beforeprint', ()=>{ const seeds=loadSeeds(); buildPrint(seeds); });

function buildPrint(seeds){
  const data=(seeds||[]).slice().sort((a,b)=>a.rk-b.rk); const groups=[];
  for(let i=0;i<4;i++){ const start=i*50,end=start+50; const g=data.slice(start,end); if(g.length>0||i===0) groups.push({players:g,title:`Ranks ${start+1}-${Math.min(end,data.length)}`}); }
  $('#printGrid').innerHTML = groups.map(g => `<div class="print-col"><div class="print-col-header">${g.title}</div><ul class="list">${g.players.map((p,i)=>rowHtml(p,i)).join('')}</ul></div>`).join('');
  $('#printDate').textContent = new Date().toLocaleString();
}

/* ---------- Auto-load initial data ---------- */
async function autoLoadInitialData(){
  const githubUrl='https://raw.githubusercontent.com/turnerturn/fantasy-football-draft-buddy/refs/heads/main/seeds.json';
  $('#importUrl').value = githubUrl;
  const existing = loadSeeds(); if(existing && existing.length){ renderLiveList(existing); return; }
  try{
    const res=await fetch(githubUrl); if(!res.ok) throw new Error('fetch'); const json=await res.json();
    const processed=json.map(p=>({...p, avoid:p.avoid||false, notes:p.notes||'' })); saveSeeds(processed); renderLiveList(processed);
  }catch{
    try{ const local=await fetch('./seeds.json'); if(local.ok){ const j=await local.json(); const processed=j.map(p=>({...p, avoid:p.avoid||false, notes:p.notes||'' })); saveSeeds(processed); renderLiveList(processed); return; } }catch{}
    renderLiveList([]);
  }
}

/* ---------- Init ---------- */
autoLoadInitialData();
initPointerDnd();
// Fuzzy search input event
$('#searchInput').addEventListener('input', (e) => {
  const term = e.target.value;
  const seeds = loadSeeds();
  renderLiveList(seeds, term);
});

// --- Rosters Modal Logic ---
const ROSTER_SLOTS = [
  'QB','RB','WR','WR','TE','FLEX','FLEX','FLEX','D/ST','K',
];
const BENCH_SLOTS = Array(6).fill('Bench');

function getTeamPlayers(teamId, seeds) {
  return seeds.filter(p => p.assignedTeam === teamId);
}

function getRosterByTeam(teamId, seeds) {
  // Returns {starters:[], bench:[]} for a team
  const players = getTeamPlayers(teamId, seeds).slice();
  // Sort by assigned slot order, fallback to rank
  const starters = [];
  const bench = [];
  // Assign slots by position, then fill flex, then bench
  const used = new Set();
  for (const slot of ROSTER_SLOTS) {
    let found = null;
    if (slot === 'FLEX') {
      found = players.find(p => !used.has(p.rk) && ['RB','WR','TE'].includes(p.pos));
    } else {
      found = players.find(p => !used.has(p.rk) && p.pos === slot);
    }
    if (found) { starters.push(found); used.add(found.rk); }
    else { starters.push(null); }
  }
  // Remaining go to bench
  players.forEach(p => { if (!used.has(p.rk)) bench.push(p); });
  // Fill empty bench slots
  while (bench.length < BENCH_SLOTS.length) bench.push(null);
  return {starters, bench};
}

function renderRostersModal() {
  const seeds = loadSeeds();
  const body = $('#rostersModalBody');
  body.innerHTML = LEAGUE_TEAMS.map(team => {
    const {starters, bench} = getRosterByTeam(team.id, seeds);
    return `
      <div class="roster-summary" style="margin-bottom:32px;">
        <div style="font-weight:bold;font-size:16px;margin-bottom:6px;">${team.id} — ${escapeHtml(team.team)} <span style="color:var(--muted);font-size:13px;">(${escapeHtml(team.manager)})</span></div>
        <table style="width:100%;border-collapse:collapse;background:var(--card);border-radius:8px;overflow:hidden;">
          <thead><tr style="background:var(--chip);color:var(--muted);font-size:13px;"><th style="width:60px;padding:6px 4px;">SLOT</th><th style="padding:6px 4px;">PLAYER</th></tr></thead>
          <tbody>
            ${ROSTER_SLOTS.map((slot, i) => {
              const p = starters[i];
              return `<tr style="border-bottom:1px solid var(--border);">
                <td style="font-weight:600;padding:8px 4px;">${slot}</td>
                <td style="padding:8px 4px;display:flex;align-items:center;gap:8px;">
                  ${p ? `<img src="https://cdn.jsdelivr.net/gh/turnerturn/fantasy-football-draft-buddy@main/avatar-placeholder.png" alt="avatar" style="width:32px;height:32px;opacity:.25;border-radius:50%;background:#fff;"> <span style="flex:1;">${escapeHtml(p.name)}</span> <button class="btn-trash" data-team="${team.id}" data-rk="${p.rk}" title="Remove player" style="background:none;border:none;color:var(--danger);font-size:18px;cursor:pointer;"><i class="bi bi-trash"></i></button>` : `<img src="https://cdn.jsdelivr.net/gh/turnerturn/fantasy-football-draft-buddy@main/avatar-placeholder.png" alt="avatar" style="width:32px;height:32px;opacity:.25;border-radius:50%;background:#fff;"> <span style="flex:1;color:var(--muted);">Empty</span>`}
                </td>
              </tr>`;
            }).join('')}
            <tr><td colspan="2" style="background:var(--chip);height:8px;"></td></tr>
            ${BENCH_SLOTS.map((slot, i) => {
              const p = bench[i];
              return `<tr style="border-bottom:1px solid var(--border);">
                <td style="font-weight:600;padding:8px 4px;">${slot}</td>
                <td style="padding:8px 4px;display:flex;align-items:center;gap:8px;">
                  ${p ? `<img src="https://cdn.jsdelivr.net/gh/turnerturn/fantasy-football-draft-buddy@main/avatar-placeholder.png" alt="avatar" style="width:32px;height:32px;opacity:.25;border-radius:50%;background:#fff;"> <span style="flex:1;">${escapeHtml(p.name)}</span> <button class="btn-trash" data-team="${team.id}" data-rk="${p.rk}" title="Remove player" style="background:none;border:none;color:var(--danger);font-size:18px;cursor:pointer;"><i class="bi bi-trash"></i></button>` : `<img src="https://cdn.jsdelivr.net/gh/turnerturn/fantasy-football-draft-buddy@main/avatar-placeholder.png" alt="avatar" style="width:32px;height:32px;opacity:.25;border-radius:50%;background:#fff;"> <span style="flex:1;color:var(--muted);">Empty</span>`}
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  }).join('');
  // Add event listeners for trash buttons
  body.querySelectorAll('.btn-trash').forEach(btn => {
    btn.onclick = (e) => {
      const teamId = btn.getAttribute('data-team');
      const rk = parseInt(btn.getAttribute('data-rk'), 10);
      if (!teamId || !rk) return;
      const seeds = loadSeeds();
      const player = seeds.find(p => p.rk === rk && p.assignedTeam === teamId);
      if (player) {
        player.assignedTeam = null;
        saveSeeds(seeds);
        renderLiveList(seeds);
        renderRostersModal();
      }
    };
  });
}

function openRostersModal() {
  renderRostersModal();
  const modal = $('#rostersModalBackdrop');
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
  document.body.style.overflow = 'hidden';
}
function closeRostersModal() {
  const modal = $('#rostersModalBackdrop');
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
  document.body.style.overflow = '';
}

$('#btnRosters').addEventListener('click', openRostersModal);
$('#rostersModalClose').addEventListener('click', closeRostersModal);
$('#rostersModalCancel').addEventListener('click', closeRostersModal);
$('#rostersModalBackdrop').addEventListener('click', (e) => { if (e.target === $('#rostersModalBackdrop')) closeRostersModal(); });
</script>
</body>
</html>
